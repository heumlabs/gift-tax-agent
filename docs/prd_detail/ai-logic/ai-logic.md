# AI 로직 및 상담 흐름 설계

문서 버전: v1.0  
연관 문서: `docs/PRD.md`, `docs/backend-architecture.md`

### 1. 개요

본 문서는 사용자와의 상담 흐름을 효과적으로 제어하고, 정확한 정보를 제공하기 위한 AI 파이프라인과 로직을 정의합니다. 시스템은 크게 **대화 관리**, **정보 수집**, **RAG 검색**, **계산**, **답변 생성**의 5단계로 구성됩니다. 증여·상속 도메인 정확도를 위해 국세기본법뿐 아니라 `상속세 및 증여세법`과 그 하위 법령을 데이터 파이프라인에서 우선 수집·벡터화하여 기본 말뭉치로 사용합니다.

### 2. 핵심 AI 파이프라인

사용자 메시지 하나를 처리하는 전체 흐름은 다음과 같습니다.

1.  **의도 및 개체 인식 (Intent & Entity Recognition)**
    -   사용자의 첫 질문을 분석하여 핵심 의도(`intent`)와 주요 정보(`entity`)를 파악합니다.
    -   **예시**: "아버지에게 1억 증여 시 세금은?"
        -   **의도**: `증여세_계산`
        -   **개체**: `증여자: 부`, `수증자: 본인`, `금액: 1억원`, `재산 유형: 현금`

2.  **필수 정보 확인 및 질문 생성 (Parameter Gathering)**
    -   파악된 의도(`증여세_계산`)에 필요한 필수 정보 목록과 현재까지 수집된 정보를 비교합니다.
    -   **필수 정보 목록 (예시)**: `증여-수증 관계`, `거주자 여부`, `증여 재산 유형 및 가액`, `최근 10년 내 동일인 증여 여부` 등
    -   부족한 정보가 있다면, 사용자에게 명확하게 되묻는 질문(`clarifying questions`)을 생성합니다. 이는 서비스의 핵심인 '상담형' 경험을 제공합니다.

3.  **RAG 기반 법령/사례 검색 (Retrieval-Augmented Generation)**
    -   충분한 정보가 수집되면, 대화의 핵심 키워드를 사용하여 `pgvector`에 저장된 법령, 예규, 판례 데이터베이스를 검색합니다.
    -   **검색 쿼리 (예시)**: "직계존속 증여재산 공제", "현금 증여 신고기한"
    -   가장 관련성 높은 문서 조각(chunk)들을 컨텍스트로 확보합니다.

4.  **결정론적 세금 계산 (Deterministic Calculation)**
    -   수집된 정형 데이터(금액, 관계, 기간 등)는 LLM이 아닌, 사전에 정의된 `TaxCalculationEngine`으로 전달됩니다.
    -   이 엔진은 `tax_rule_config` 테이블의 최신 세율과 공제액을 바탕으로 정확한 예상 세액을 계산합니다.
    -   **장점**: LLM의 환각(Hallucination) 현상을 원천 차단하고 계산 결과의 신뢰성을 보장합니다.

5.  **최종 답변 합성 (Answer Synthesis)**
    -   LLM은 아래의 모든 정보를 종합하여 최종 답변을 자연스러운 문장으로 생성합니다.
        1.  **시스템 프롬프트**: AI의 역할(세무 상담사), 답변 스타일, 주의사항(법적 조언 아님 명시 등) 정의
        2.  **대화 기록**: 전체 대화의 맥락 유지
        3.  **RAG 검색 결과**: 답변의 근거가 될 법령/예규 텍스트
        4.  **세금 계산 결과**: `TaxCalculationEngine`이 계산한 정확한 숫자
        5.  **지침**: "위 정보를 종합하여, 전제 조건을 명시하고 계산 과정을 설명한 뒤, 법적 근거를 인용하여 친절하게 답변해 주세요."

### 3. 프롬프트 엔지니어링 전략

-   **페르소나 정의**: 시스템 프롬프트에 "당신은 사용자의 복잡한 세금 문제를 돕는 전문 AI 세무 상담사 '슈킹'입니다. 항상 신중하고, 근거를 제시하며, 확정적인 조언이 아님을 명시해야 합니다." 와 같이 명확한 역할을 부여합니다.
-   **구조화된 출력 요구**: LLM이 JSON 형식의 일부 데이터를 포함하여 답변하도록 유도합니다. (예: `citations`, `calculation_details`). 이를 통해 프런트엔드에서 구조화된 정보를 더 쉽게 파싱하여 UI에 표시할 수 있습니다.
-   **Few-shot Learning**: 복잡한 질문에 대해 모범적인 질문-답변 예시 몇 개를 프롬프트에 포함시켜 LLM이 원하는 답변 형식과 깊이를 학습하도록 합니다.

### 4. RAG 문서 파이프라인

-   **소스**: 국세법령정보시스템, 법제처 등 신뢰할 수 있는 정부 기관의 공개 데이터 (우선 대상: `국세기본법` 3종, `상속세 및 증여세법` 및 시행령·시행규칙, 관련 예규·판례)
-   **전처리**:
    -   웹 크롤링 또는 파일 다운로드 후 HTML/PDF에서 텍스트를 추출합니다.
    -   불필요한 공백, 머리글/바닥글 등을 제거합니다.
-   **분할 (Chunking)**:
    -   법률의 '조', '항' 등 의미 있는 단위로 텍스트를 분할하여 검색 정확도를 높입니다.
    -   각 chunk가 독립적으로 이해될 수 있도록 상위 제목 등 메타데이터를 포함합니다.
-   **임베딩 및 인덱싱**:
    -   분할된 텍스트 덩어리를 한국어에 특화된 임베딩 모델(예: `ko-sroberta-multitask`)을 사용하여 벡터로 변환합니다.
    -   텍스트 원본과 벡터를 PostgreSQL의 `sources` 테이블에 저장하고 `pgvector`의 IVFFlat 인덱스를 생성하여 빠른 검색을 지원합니다.
-   **주기적 업데이트**: 법령 개정에 대응하기 위해 월 1회 또는 분기별로 전체 파이프라인을 재실행하여 데이터베이스를 최신 상태로 유지합니다.
