# ì¦ì—¬ì„¸ ê³„ì‚° ì›Œí¬í”Œë¡œ ê³ ë„í™” ì„¤ê³„ ë¬¸ì„œ

## ëª©ì°¨
1. [ì‘ë‹µ í’ˆì§ˆ ê°œì„ ](#1-ì‘ë‹µ-í’ˆì§ˆ-ê°œì„ )
2. [Calculation API ìŠ¤í™](#2-calculation-api-ìŠ¤í™)
3. [Frontend API Contract](#3-frontend-api-contract)

---

# 1. ì‘ë‹µ í’ˆì§ˆ ê°œì„ 

## 1.1 í˜„í™© ë¶„ì„

### í˜„ì¬ ì‘ë‹µ ì˜ˆì‹œ
```
ì§ê³„ì¡´ì†ìœ¼ë¡œë¶€í„° 1,000,000,000ì›ì„ ì¦ì—¬ë°›ì„ ê²½ìš°, ì˜ˆìƒë˜ëŠ” ì¦ì—¬ì„¸ëŠ” 225,000,000ì›ì…ë‹ˆë‹¤.

ì¦ì—¬ì¬ì‚°ê°€ì•¡ 1,000,000,000ì›ì—ì„œ ì§ê³„ì¡´ì† ê³µì œì•¡ 50,000,000ì›ì„ ì œì™¸í•œ ê³¼ì„¸í‘œì¤€ì€ 950,000,000ì›ì…ë‹ˆë‹¤. ê³¼ì„¸í‘œì¤€ 950,000,000ì›ì€ 5ì–µ ì´ˆê³¼ 10ì–µ ì´í•˜ ì„¸ìœ¨ êµ¬ê°„ì— í•´ë‹¹í•˜ì—¬ 30%ì˜ ì„¸ìœ¨ì´ ì ìš©ë©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚°ì¶œëœ ìµœì¢… ì¦ì—¬ì„¸ì•¡ì€ 225,000,000ì›ì…ë‹ˆë‹¤.
```

### ë¬¸ì œì 
- âŒ ê¸°ê³„ì ì´ê³  ë”±ë”±í•œ í†¤
- âŒ ìˆ«ì ê°€ë…ì„± ë–¨ì–´ì§ (1,000,000,000ì›)
- âŒ ê³„ì‚° ê³¼ì • ë¶ˆëª…í™• (ëˆ„ì§„ê³µì œ ì„¤ëª… ì—†ìŒ)
- âŒ ì„¸ìœ¨ êµ¬ê°„ ìƒì„¸ ì„¤ëª… ë¶€ì¡±
- âŒ ì¶”ê°€ ê³ ë ¤ì‚¬í•­ ì•ˆë‚´ ì—†ìŒ
- âŒ í•œ ë¬¸ë‹¨ì— ëª¨ë“  ì •ë³´ ì••ì¶•

### ëª©í‘œ ì‘ë‹µ (ChatGPT ìˆ˜ì¤€ + ì „ë¬¸ì„±)
```
ğŸ“‹ ì¦ì—¬ì„¸ ê³„ì‚° ê²°ê³¼

ì•„ë²„ì§€ê»˜ì„œ ì¦ì—¬í•˜ì‹œëŠ” 10ì–µì›ì— ëŒ€í•œ ì¦ì—¬ì„¸ëŠ” ì•½ 2ì–µ 2,500ë§Œì›ì´ì—ìš”.

ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •

â‘  ì¦ì—¬ì¬ì‚°ê°€ì•¡
   10ì–µì›

â‘¡ ì¦ì—¬ì¬ì‚°ê³µì œ
   - ì§ê³„ì¡´ì†(ë¶€ëª¨) â†’ ì„±ì¸ìë…€ ê¸°ë³¸ê³µì œ: 5,000ë§Œì›

â‘¢ ê³¼ì„¸í‘œì¤€
   10ì–µì› - 5,000ë§Œì› = 9ì–µ 5,000ë§Œì›

â‘£ ì„¸ìœ¨ ì ìš©
   ê³¼ì„¸í‘œì¤€ 9.5ì–µì›ì€ '5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜' êµ¬ê°„ì— í•´ë‹¹í•´ìš”.

   [ì¦ì—¬ì„¸ ì„¸ìœ¨í‘œ]
   â€¢ 1ì–µ ì´í•˜: 10% (ëˆ„ì§„ê³µì œ 0ì›)
   â€¢ 1ì–µ ì´ˆê³¼ ~ 5ì–µ ì´í•˜: 20% (ëˆ„ì§„ê³µì œ 1,000ë§Œì›)
   â€¢ 5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜: 30% (ëˆ„ì§„ê³µì œ 6,000ë§Œì›) â† ì—¬ê¸°!
   â€¢ 10ì–µ ì´ˆê³¼ ~ 30ì–µ ì´í•˜: 40% (ëˆ„ì§„ê³µì œ 1.6ì–µì›)
   â€¢ 30ì–µ ì´ˆê³¼: 50% (ëˆ„ì§„ê³µì œ 4.6ì–µì›)

   ê³„ì‚°:
   9.5ì–µì› Ã— 30% = 2ì–µ 8,500ë§Œì›
   2ì–µ 8,500ë§Œì› - 6,000ë§Œì›(ëˆ„ì§„ê³µì œ) = 2ì–µ 2,500ë§Œì›

âš ï¸ ì¶”ê°€ë¡œ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­

â€¢ ê³¼ê±° 10ë…„ê°„ ë™ì¼ì¸(ì•„ë²„ì§€)ìœ¼ë¡œë¶€í„° ì¦ì—¬ë°›ì€ ê¸ˆì•¡ì´ ìˆìœ¼ì‹ ê°€ìš”?
  â†’ ìˆë‹¤ë©´ í•©ì‚°ë˜ì–´ ì„¸ê¸ˆì´ ë” ë‚˜ì˜¬ ìˆ˜ ìˆì–´ìš”.

â€¢ í˜„ê¸ˆ ì¦ì—¬ì¸ê°€ìš”, ë¶€ë™ì‚° ì¦ì—¬ì¸ê°€ìš”?
  â†’ ë¶€ë™ì‚°ì€ ì·¨ë“ì„¸(3.5%) + ì§€ë°©êµìœ¡ì„¸(0.35%)ê°€ ë³„ë„ë¡œ ë°œìƒí•´ìš”.

ğŸ“… ì‹ ê³  ê¸°í•œ
ì¦ì—¬ì¼(2025ë…„ 8ì›” 1ì¼)ë¡œë¶€í„° 3ê°œì›” ì´ë‚´ì¸ 2025ë…„ 10ì›” 31ì¼ê¹Œì§€ ì‹ ê³ í•˜ì…”ì•¼ í•´ìš”.
í˜„ì¬ ê¸°ì¤€ 13ì¼ ë‚¨ì•˜ìœ¼ë‹ˆ ì„œë‘ë¥´ì‹œëŠ” ê²Œ ì¢‹ê² ì–´ìš”!

ğŸ’¡ ì°¸ê³ ì‚¬í•­
ì´ ê³„ì‚°ì€ ê¸°ë³¸ì ì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì˜ˆìƒì¹˜ì˜ˆìš”.
ì •í™•í•œ ì‹ ê³ ë¥¼ ìœ„í•´ì„œëŠ” ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”.
```

## 1.2 ê°œì„  ì „ëµ

### í˜ë¥´ì†Œë‚˜ ì„¤ì •
**30ëŒ€ ì´ˆë°˜ ì—¬ì„± ì„¸ë¬´ì‚¬**
- ì „ë¬¸ì ì´ì§€ë§Œ ì¹œê·¼í•¨
- ì¡´ëŒ“ë§ + ë°˜ë§ ì ì ˆíˆ í˜¼ìš© ("~ì´ì—ìš”", "~í•´ìš”")
- ë”±ë”±í•œ ë²•ë¥  ìš©ì–´ë³´ë‹¤ëŠ” ì‰¬ìš´ ì„¤ëª… ìš°ì„ 
- ì´ëª¨ì§€ ì ì ˆíˆ í™œìš© (ê³¼í•˜ì§€ ì•Šê²Œ)
- "~ì…ë‹ˆë‹¤" â†’ "~ì´ì—ìš”/í•´ìš”"

### ìˆ«ì í‘œê¸°ë²• ê°œì„ 
**í˜„ì¬:** 1,000,000,000ì›
**ê°œì„ :** 10ì–µì›

**ê·œì¹™:**
- ì–µ ë‹¨ìœ„: "10ì–µì›", "4.5ì–µì›"
- ì²œë§Œ ë‹¨ìœ„: "5,000ë§Œì›", "2ì–µ 2,500ë§Œì›"
- í˜¼í•©: "9ì–µ 5,000ë§Œì›"
- ì†Œìˆ˜ì : ì–µ ë‹¨ìœ„ì—ì„œë§Œ ì‚¬ìš© (ì˜ˆ: 4.5ì–µ)

### ì‘ë‹µ êµ¬ì¡°í™”
```
1. ğŸ“‹ ê²°ê³¼ ìš”ì•½ (1-2ì¤„)
   - í•µì‹¬ ì •ë³´ë§Œ ê°„ê²°í•˜ê²Œ

2. ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •
   â‘  ì¦ì—¬ì¬ì‚°ê°€ì•¡
   â‘¡ ì¦ì—¬ì¬ì‚°ê³µì œ
   â‘¢ ê³¼ì„¸í‘œì¤€
   â‘£ ì„¸ìœ¨ ì ìš©
      - ì„¸ìœ¨í‘œ ì‹œê°í™”
      - ëˆ„ì§„ê³µì œ ìƒì„¸ ì„¤ëª…
      - ë‹¨ê³„ë³„ ê³„ì‚°

3. âš ï¸ ì¶”ê°€ í™•ì¸ì‚¬í•­
   - ê³¼ê±° ì¦ì—¬ ì—¬ë¶€
   - ì¬ì‚° ì¢…ë¥˜ (í˜„ê¸ˆ/ë¶€ë™ì‚°)
   - ê¸°íƒ€ íŠ¹ìˆ˜ ìƒí™©

4. ğŸ“… ì‹ ê³  ê¸°í•œ
   - ëª…í™•í•œ ë‚ ì§œ
   - ë‚¨ì€ ê¸°ê°„
   - ê¸°í•œ í›„ ë¶ˆì´ìµ

5. ğŸ’¡ ì°¸ê³ ì‚¬í•­
   - ë©´ì±… ì¡°í•­ (ë¶€ë“œëŸ½ê²Œ)
   - ì¶”ê°€ ìƒë‹´ ê¶Œìœ 
```

## 1.3 êµ¬í˜„ ê³„íš

### Phase 1: Calculator ê°œì„ 

**íŒŒì¼:** `ai/tools/gift_tax/calculator.py`

**ìƒˆ ìœ í‹¸ í•¨ìˆ˜ ì¶”ê°€:**

```python
def format_amount(amount: int) -> str:
    """
    ê¸ˆì•¡ì„ ì½ê¸° ì¢‹ì€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜

    Examples:
        1000000000 â†’ "10ì–µì›"
        950000000 â†’ "9ì–µ 5,000ë§Œì›"
        50000000 â†’ "5,000ë§Œì›"
        225000000 â†’ "2ì–µ 2,500ë§Œì›"
        450000000 â†’ "4.5ì–µì›"
    """
    ì–µ = amount // 100000000
    ë§Œ = (amount % 100000000) // 10000

    if ë§Œ == 0:
        return f"{ì–µ}ì–µì›"
    elif ë§Œ % 1000 == 0:
        # ì²œë§Œ ë‹¨ìœ„ë¡œ ë–¨ì–´ì§€ë©´
        ì²œë§Œ = ë§Œ // 1000
        return f"{ì–µ}ì–µ {ì²œë§Œ:,}ë§Œì›" if ì–µ > 0 else f"{ì²œë§Œ:,}ë§Œì›"
    else:
        # ì†Œìˆ˜ì  í‘œí˜„ (ì–µ ë‹¨ìœ„ë§Œ)
        if ì–µ > 0 and ë§Œ >= 5000:
            return f"{ì–µ + ë§Œ/10000:.1f}ì–µì›"
        return f"{ì–µ}ì–µ {ë§Œ:,}ë§Œì›" if ì–µ > 0 else f"{ë§Œ:,}ë§Œì›"


def get_tax_bracket_info(taxable_base: int) -> dict:
    """
    ê³¼ì„¸í‘œì¤€ì— í•´ë‹¹í•˜ëŠ” ì„¸ìœ¨ êµ¬ê°„ ì •ë³´ ë°˜í™˜
    """
    brackets = [
        (100000000, 0.10, 0, "1ì–µ ì´í•˜"),
        (500000000, 0.20, 10000000, "1ì–µ ì´ˆê³¼ ~ 5ì–µ ì´í•˜"),
        (1000000000, 0.30, 60000000, "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜"),
        (3000000000, 0.40, 160000000, "10ì–µ ì´ˆê³¼ ~ 30ì–µ ì´í•˜"),
        (float('inf'), 0.50, 460000000, "30ì–µ ì´ˆê³¼"),
    ]

    for max_val, rate, deduction, range_str in brackets:
        if taxable_base <= max_val:
            return {
                "range": range_str,
                "rate": rate,
                "rate_display": f"{int(rate * 100)}%",
                "progressive_deduction": deduction,
                "progressive_deduction_formatted": format_amount(deduction)
            }


def get_all_tax_brackets(current_taxable_base: int) -> list[dict]:
    """
    ì „ì²´ ì„¸ìœ¨í‘œ ì •ë³´ ë°˜í™˜ (í˜„ì¬ êµ¬ê°„ í‘œì‹œ í¬í•¨)
    """
    brackets_data = [
        (0, 100000000, 0.10, 0, "1ì–µ ì´í•˜"),
        (100000001, 500000000, 0.20, 10000000, "1ì–µ ì´ˆê³¼ ~ 5ì–µ ì´í•˜"),
        (500000001, 1000000000, 0.30, 60000000, "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜"),
        (1000000001, 3000000000, 0.40, 160000000, "10ì–µ ì´ˆê³¼ ~ 30ì–µ ì´í•˜"),
        (3000000001, float('inf'), 0.50, 460000000, "30ì–µ ì´ˆê³¼"),
    ]

    result = []
    for min_val, max_val, rate, deduction, range_str in brackets_data:
        is_current = min_val <= current_taxable_base <= max_val
        result.append({
            "range": range_str,
            "min": min_val,
            "max": max_val if max_val != float('inf') else None,
            "rate": rate,
            "rate_display": f"{int(rate * 100)}%",
            "progressive_deduction": deduction,
            "progressive_deduction_formatted": format_amount(deduction),
            "is_current": is_current
        })

    return result
```

**ê¸°ì¡´ í•¨ìˆ˜ ê°œì„ :**

`calculate_gift_tax_simple()` í•¨ìˆ˜ì— `calculation_breakdown` ì¶”ê°€:

```python
def calculate_gift_tax_simple(...) -> GiftTaxSimpleOutput:
    """
    ê¸°ì¡´ ë¡œì§ + breakdown ì¶”ê°€
    """
    # ... ê¸°ì¡´ ê³„ì‚° ë¡œì§ ...

    # Breakdown ì •ë³´ ìƒì„±
    tax_bracket = get_tax_bracket_info(taxable_base)
    all_brackets = get_all_tax_brackets(taxable_base)

    # ê´€ê³„ í•œê¸€ ë³€í™˜
    relationship_map = {
        "ì§ê³„ì¡´ì†": "ë¶€ëª¨ë‹˜",
        "ì§ê³„ë¹„ì†": "ìë…€",
        "ë°°ìš°ì": "ë°°ìš°ì",
        "ê¸°íƒ€ì¹œì¡±": "ê¸°íƒ€ ì¹œì¡±"
    }
    relationship_korean = relationship_map.get(donor_relationship, donor_relationship)
    recipient_type = "ë¯¸ì„±ë…„ìë…€" if is_minor_recipient else "ì„±ì¸ìë…€"

    calculation_steps = [
        {
            "step": 1,
            "description": "ì¦ì—¬ì¬ì‚°ê°€ì•¡",
            "value": gift_property_value,
            "formatted": format_amount(gift_property_value)
        },
        {
            "step": 2,
            "description": f"ì¦ì—¬ì¬ì‚°ê³µì œ ({relationship_korean} â†’ {recipient_type})",
            "value": total_deduction,
            "formatted": format_amount(total_deduction),
            "breakdown": {
                "basic": format_amount(basic_deduction),
                "marriage": format_amount(marriage_deduction_amount) if marriage_deduction_amount else None,
                "childbirth": format_amount(childbirth_deduction_amount) if childbirth_deduction_amount else None
            }
        },
        {
            "step": 3,
            "description": "ê³¼ì„¸í‘œì¤€",
            "value": taxable_base,
            "formatted": format_amount(taxable_base),
            "calculation": f"{format_amount(gift_property_value)} - {format_amount(total_deduction)}"
        },
        {
            "step": 4,
            "description": "ì‚°ì¶œì„¸ì•¡ (ëˆ„ì§„ê³µì œ ì „)",
            "value": calculated_tax,
            "formatted": format_amount(calculated_tax),
            "calculation": f"{format_amount(taxable_base)} Ã— {tax_bracket['rate_display']}"
        },
        {
            "step": 5,
            "description": "ëˆ„ì§„ê³µì œ",
            "value": tax_bracket["progressive_deduction"],
            "formatted": tax_bracket["progressive_deduction_formatted"],
            "info": tax_bracket["range"]
        },
        {
            "step": 6,
            "description": "ìµœì¢… ì¦ì—¬ì„¸ì•¡",
            "value": final_tax,
            "formatted": format_amount(final_tax),
            "calculation": f"{format_amount(calculated_tax)} - {tax_bracket['progressive_deduction_formatted']}"
        }
    ]

    breakdown = {
        "formatted_amounts": {
            "gift_value": format_amount(gift_property_value),
            "total_deduction": format_amount(total_deduction),
            "taxable_base": format_amount(taxable_base),
            "calculated_tax": format_amount(calculated_tax),
            "progressive_deduction": tax_bracket["progressive_deduction_formatted"],
            "final_tax": format_amount(final_tax)
        },
        "tax_bracket": tax_bracket,
        "all_tax_brackets": all_brackets,
        "calculation_steps_detailed": calculation_steps
    }

    return GiftTaxSimpleOutput(
        # ê¸°ì¡´ í•„ë“œë“¤...
        calculation_breakdown=breakdown  # ìƒˆë¡œ ì¶”ê°€
    )
```

### Phase 2: Synthesis Prompt ì¬ì„¤ê³„

**íŒŒì¼:** `ai/prompts/clarifying.py`

ìƒˆë¡œìš´ `SYNTHESIS_PROMPT` ì¶”ê°€:

```python
SYNTHESIS_PROMPT_V2 = """ë‹¹ì‹ ì€ 30ëŒ€ ì´ˆë°˜ ì—¬ì„± ì„¸ë¬´ì‚¬ì˜ˆìš”. ì „ë¬¸ì„±ì„ ìœ ì§€í•˜ë©´ì„œë„ ì¹œê·¼í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

### í˜ë¥´ì†Œë‚˜ ê°€ì´ë“œë¼ì¸
- ì¡´ëŒ“ë§ + ë°˜ë§ í˜¼ìš©: "~ì´ì—ìš”", "~í•´ìš”", "~í•˜ì…”ì•¼ í•´ìš”"
- ì „ë¬¸ì ì´ì§€ë§Œ ë¶€ë‹´ìŠ¤ëŸ½ì§€ ì•Šê²Œ
- ë¶ˆí•„ìš”í•œ ì¸ì‚¬ë§ ì œê±° ("ì•ˆë…•í•˜ì„¸ìš”", "ë¬¸ì˜í•˜ì‹ ")
- ì´ëª¨ì§€ ì ì ˆíˆ í™œìš© (ì„¹ì…˜ êµ¬ë¶„ìš©)

### ê³„ì‚° ê²°ê³¼ ì •ë³´

**ìµœì¢… ì¦ì—¬ì„¸**: {final_tax_formatted}
**ì¦ì—¬ì¬ì‚°ê°€ì•¡**: {gift_value_formatted}
**ê³µì œì•¡**: {deduction_formatted}
**ê³¼ì„¸í‘œì¤€**: {taxable_base_formatted}

**ì„¸ìœ¨ êµ¬ê°„**: {tax_bracket_range}
**ì ìš© ì„¸ìœ¨**: {tax_rate}
**ëˆ„ì§„ê³µì œ**: {progressive_deduction_formatted}

**ìƒì„¸ ê³„ì‚° ê³¼ì •**:
{calculation_steps_formatted}

**ì „ì²´ ì„¸ìœ¨í‘œ**:
{all_tax_brackets_formatted}

**ì£¼ì˜ì‚¬í•­**:
{warnings_formatted}

---

### ì‘ë‹µ êµ¬ì¡°

ì•„ë˜ êµ¬ì¡°ë¥¼ **ë°˜ë“œì‹œ** ë”°ë¼ì£¼ì„¸ìš”:

```
ğŸ“‹ ì¦ì—¬ì„¸ ê³„ì‚° ê²°ê³¼

[í•œ ì¤„ ìš”ì•½: ëˆ„êµ¬ì—ê²Œì„œ, ì–¼ë§ˆë¥¼ ì¦ì—¬ë°›ì„ ë•Œ, ì¦ì—¬ì„¸ê°€ ì–¼ë§ˆì¸ì§€]

ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •

â‘  ì¦ì—¬ì¬ì‚°ê°€ì•¡
   [ê¸ˆì•¡ê³¼ ê°„ë‹¨í•œ ì„¤ëª…]

â‘¡ ì¦ì—¬ì¬ì‚°ê³µì œ
   - [ê³µì œ ì¢…ë¥˜ì™€ ê¸ˆì•¡ ì„¤ëª…]

â‘¢ ê³¼ì„¸í‘œì¤€
   [ê³„ì‚°ì‹ í¬í•¨]

â‘£ ì„¸ìœ¨ ì ìš©
   ê³¼ì„¸í‘œì¤€ [ê¸ˆì•¡]ì€ '[êµ¬ê°„ëª…]' êµ¬ê°„ì— í•´ë‹¹í•´ìš”.

   [ì¦ì—¬ì„¸ ì„¸ìœ¨í‘œ]
   [ì „ì²´ ì„¸ìœ¨í‘œë¥¼ bulletsë¡œ, í˜„ì¬ êµ¬ê°„ì€ í™”ì‚´í‘œë‚˜ ê°•ì¡°ë¡œ í‘œì‹œ]

   ê³„ì‚°:
   [ë‹¨ê³„ë³„ ê³„ì‚° ê³¼ì •ì„ ëª…í™•í•˜ê²Œ]
   - ì‚°ì¶œì„¸ì•¡ ê³„ì‚°
   - ëˆ„ì§„ê³µì œ ì°¨ê°
   - ìµœì¢…ì„¸ì•¡

âš ï¸ ì¶”ê°€ë¡œ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­

â€¢ ê³¼ê±° 10ë…„ê°„ ë™ì¼ì¸ìœ¼ë¡œë¶€í„° ì¦ì—¬ë°›ì€ ê¸ˆì•¡ì´ ìˆìœ¼ì‹ ê°€ìš”?
  â†’ [ì„¤ëª…]

â€¢ í˜„ê¸ˆ ì¦ì—¬ì¸ê°€ìš”, ë¶€ë™ì‚° ì¦ì—¬ì¸ê°€ìš”?
  â†’ [ì„¤ëª…]

[warningsê°€ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì¶”ê°€ë¡œ í‘œì‹œ]

ğŸ“… ì‹ ê³  ê¸°í•œ
[ì¦ì—¬ì¼ ê¸°ì¤€ 3ê°œì›”, ì •í™•í•œ ë‚ ì§œ, ë‚¨ì€ ê¸°ê°„]
[ê¸°í•œ ê²½ê³¼ ì‹œ ê°€ì‚°ì„¸ ì•ˆë‚´]

ğŸ’¡ ì°¸ê³ ì‚¬í•­
ì´ ê³„ì‚°ì€ ê¸°ë³¸ì ì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì˜ˆìƒì¹˜ì˜ˆìš”.
ì •í™•í•œ ì‹ ê³ ë¥¼ ìœ„í•´ì„œëŠ” ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”.
```

### ì‘ì„± ê·œì¹™

1. **ìˆ«ì í‘œê¸°**
   - ì–µ ë‹¨ìœ„: "10ì–µì›", "4.5ì–µì›"
   - ì²œë§Œ ë‹¨ìœ„: "5,000ë§Œì›", "2ì–µ 2,500ë§Œì›"
   - ì–µ/ë§Œ í˜¼í•©: "9ì–µ 5,000ë§Œì›"

2. **í†¤ì•¤ë§¤ë„ˆ**
   - "~ì…ë‹ˆë‹¤" â†’ "~ì´ì—ìš”/í•´ìš”"
   - "í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤" â†’ "~í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”"
   - "ê³¼ì„¸í‘œì¤€" ê°™ì€ ìš©ì–´ëŠ” ì‚¬ìš©í•˜ë˜, ë°”ë¡œ ë’¤ì— ì‰¬ìš´ ì„¤ëª… ì¶”ê°€

3. **ê³„ì‚° ê³¼ì • ì„¤ëª…**
   - ê° ë‹¨ê³„ë§ˆë‹¤ "ì™œ ì´ë ‡ê²Œ ê³„ì‚°í•˜ëŠ”ì§€" ê°„ë‹¨íˆ ì„¤ëª…
   - ëˆ„ì§„ê³µì œ ê°œë…ì„ ì‰½ê²Œ ì„¤ëª…

4. **ì„¸ìœ¨í‘œ í‘œì‹œ**
   - ì „ì²´ ì„¸ìœ¨í‘œë¥¼ ë³´ì—¬ì£¼ë˜
   - í˜„ì¬ í•´ë‹¹í•˜ëŠ” êµ¬ê°„ì€ í™”ì‚´í‘œë‚˜ "â† ì—¬ê¸°!" ê°™ì€ í‘œì‹œë¡œ ê°•ì¡°

---

### Few-shot ì˜ˆì œ

**ì˜ˆì œ 1: ë¶€ëª¨ â†’ ì„±ì¸ìë…€ 10ì–µ ì¦ì—¬**

ì…ë ¥:
- ì¦ì—¬ì¬ì‚°ê°€ì•¡: 10ì–µì›
- ê´€ê³„: ì§ê³„ì¡´ì†
- ê³µì œì•¡: 5,000ë§Œì›
- ê³¼ì„¸í‘œì¤€: 9ì–µ 5,000ë§Œì›
- ì„¸ìœ¨: 30%, ëˆ„ì§„ê³µì œ 6,000ë§Œì›
- ìµœì¢…ì„¸ì•¡: 2ì–µ 2,500ë§Œì›

ì¶œë ¥:
```
ğŸ“‹ ì¦ì—¬ì„¸ ê³„ì‚° ê²°ê³¼

ì•„ë²„ì§€ê»˜ì„œ ì¦ì—¬í•˜ì‹œëŠ” 10ì–µì›ì— ëŒ€í•œ ì¦ì—¬ì„¸ëŠ” ì•½ 2ì–µ 2,500ë§Œì›ì´ì—ìš”.

ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •

â‘  ì¦ì—¬ì¬ì‚°ê°€ì•¡
   10ì–µì›

â‘¡ ì¦ì—¬ì¬ì‚°ê³µì œ
   - ì§ê³„ì¡´ì†(ë¶€ëª¨) â†’ ì„±ì¸ìë…€ ê¸°ë³¸ê³µì œ: 5,000ë§Œì›

â‘¢ ê³¼ì„¸í‘œì¤€
   10ì–µì› - 5,000ë§Œì› = 9ì–µ 5,000ë§Œì›

â‘£ ì„¸ìœ¨ ì ìš©
   ê³¼ì„¸í‘œì¤€ 9.5ì–µì›ì€ '5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜' êµ¬ê°„ì— í•´ë‹¹í•´ìš”.

   [ì¦ì—¬ì„¸ ì„¸ìœ¨í‘œ]
   â€¢ 1ì–µ ì´í•˜: 10% (ëˆ„ì§„ê³µì œ 0ì›)
   â€¢ 1ì–µ ì´ˆê³¼ ~ 5ì–µ ì´í•˜: 20% (ëˆ„ì§„ê³µì œ 1,000ë§Œì›)
   â€¢ 5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜: 30% (ëˆ„ì§„ê³µì œ 6,000ë§Œì›) â† ì—¬ê¸°!
   â€¢ 10ì–µ ì´ˆê³¼ ~ 30ì–µ ì´í•˜: 40% (ëˆ„ì§„ê³µì œ 1.6ì–µì›)
   â€¢ 30ì–µ ì´ˆê³¼: 50% (ëˆ„ì§„ê³µì œ 4.6ì–µì›)

   ê³„ì‚°:
   9.5ì–µì› Ã— 30% = 2ì–µ 8,500ë§Œì›
   2ì–µ 8,500ë§Œì› - 6,000ë§Œì›(ëˆ„ì§„ê³µì œ) = 2ì–µ 2,500ë§Œì›

âš ï¸ ì¶”ê°€ë¡œ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­

â€¢ ê³¼ê±° 10ë…„ê°„ ë™ì¼ì¸(ì•„ë²„ì§€)ìœ¼ë¡œë¶€í„° ì¦ì—¬ë°›ì€ ê¸ˆì•¡ì´ ìˆìœ¼ì‹ ê°€ìš”?
  â†’ ìˆë‹¤ë©´ í•©ì‚°ë˜ì–´ ì„¸ê¸ˆì´ ë” ë‚˜ì˜¬ ìˆ˜ ìˆì–´ìš”.

â€¢ í˜„ê¸ˆ ì¦ì—¬ì¸ê°€ìš”, ë¶€ë™ì‚° ì¦ì—¬ì¸ê°€ìš”?
  â†’ ë¶€ë™ì‚°ì€ ì·¨ë“ì„¸(3.5%) + ì§€ë°©êµìœ¡ì„¸(0.35%)ê°€ ë³„ë„ë¡œ ë°œìƒí•´ìš”.

ğŸ“… ì‹ ê³  ê¸°í•œ
ì¦ì—¬ì¼(2025ë…„ 8ì›” 1ì¼)ë¡œë¶€í„° 3ê°œì›” ì´ë‚´ì¸ 2025ë…„ 10ì›” 31ì¼ê¹Œì§€ ì‹ ê³ í•˜ì…”ì•¼ í•´ìš”.
í˜„ì¬ ê¸°ì¤€ 13ì¼ ë‚¨ì•˜ìœ¼ë‹ˆ ì„œë‘ë¥´ì‹œëŠ” ê²Œ ì¢‹ê² ì–´ìš”!

ğŸ’¡ ì°¸ê³ ì‚¬í•­
ì´ ê³„ì‚°ì€ ê¸°ë³¸ì ì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì˜ˆìƒì¹˜ì˜ˆìš”.
ì •í™•í•œ ì‹ ê³ ë¥¼ ìœ„í•´ì„œëŠ” ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”.
```

**ì˜ˆì œ 2: ë°°ìš°ì ê°„ 5ì–µ ì¦ì—¬**

ì…ë ¥:
- ì¦ì—¬ì¬ì‚°ê°€ì•¡: 5ì–µì›
- ê´€ê³„: ë°°ìš°ì
- ê³µì œì•¡: 6ì–µì› (ë°°ìš°ì ê³µì œ)
- ê³¼ì„¸í‘œì¤€: 0ì› (ê³µì œ í›„ ìŒìˆ˜ì´ë¯€ë¡œ)
- ìµœì¢…ì„¸ì•¡: 0ì›

ì¶œë ¥:
```
ğŸ“‹ ì¦ì—¬ì„¸ ê³„ì‚° ê²°ê³¼

ë°°ìš°ìê»˜ì„œ ì¦ì—¬í•˜ì‹œëŠ” 5ì–µì›ì— ëŒ€í•œ ì¦ì—¬ì„¸ëŠ” 0ì›ì´ì—ìš”!

ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •

â‘  ì¦ì—¬ì¬ì‚°ê°€ì•¡
   5ì–µì›

â‘¡ ì¦ì—¬ì¬ì‚°ê³µì œ
   - ë°°ìš°ì ê°„ ì¦ì—¬ ê³µì œ: 6ì–µì›

â‘¢ ê³¼ì„¸í‘œì¤€
   5ì–µì› - 6ì–µì› = -1ì–µì› â†’ 0ì›

   ê³µì œì•¡ì´ ì¦ì—¬ì¬ì‚°ê°€ì•¡ë³´ë‹¤ í¬ê¸° ë•Œë¬¸ì— ê³¼ì„¸í‘œì¤€ì´ 0ì›ì´ ë¼ìš”.
   ë”°ë¼ì„œ ì¦ì—¬ì„¸ê°€ ë°œìƒí•˜ì§€ ì•Šì•„ìš”!

âš ï¸ ì¶”ê°€ë¡œ í™•ì¸ì´ í•„ìš”í•œ ì‚¬í•­

â€¢ ê³¼ê±° 10ë…„ê°„ ë°°ìš°ìë¡œë¶€í„° ì¦ì—¬ë°›ì€ ê¸ˆì•¡ì´ ìˆìœ¼ì‹ ê°€ìš”?
  â†’ 10ë…„ê°„ í•©ì‚°í•˜ì—¬ 6ì–µì›ê¹Œì§€ ê³µì œë˜ë¯€ë¡œ, ê³¼ê±° ì¦ì—¬ì•¡ì´ ìˆë‹¤ë©´ ê³µì œ í•œë„ê°€ ì¤„ì–´ë“¤ ìˆ˜ ìˆì–´ìš”.

ğŸ“… ì‹ ê³  ê¸°í•œ
ì¦ì—¬ì„¸ê°€ 0ì›ì´ì–´ë„ ì¦ì—¬ì¼ë¡œë¶€í„° 3ê°œì›” ì´ë‚´ì—ëŠ” ì‹ ê³ ë¥¼ í•˜ì…”ì•¼ í•´ìš”.
ì‹ ê³ ë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ ì¶”í›„ ë¬¸ì œê°€ ë  ìˆ˜ ìˆìœ¼ë‹ˆ ê¼­ ì‹ ê³ í•˜ì„¸ìš”!

ğŸ’¡ ì°¸ê³ ì‚¬í•­
ì´ ê³„ì‚°ì€ ê¸°ë³¸ì ì¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•œ ì˜ˆìƒì¹˜ì˜ˆìš”.
ì •í™•í•œ ì‹ ê³ ë¥¼ ìœ„í•´ì„œëŠ” ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”.
```

---

ì´ì œ ìœ„ êµ¬ì¡°ì™€ ì˜ˆì œë¥¼ ì°¸ê³ í•˜ì—¬, ì œê³µëœ ê³„ì‚° ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘ë‹µì„ ìƒì„±í•´ì£¼ì„¸ìš”.
"""
```

### Phase 3: Synthesis Node ê°œì„ 

**íŒŒì¼:** `ai/pipelines/langgraph_workflow.py`

`_synthesize_response()` í•¨ìˆ˜ ê°œì„ :

```python
async def _synthesize_response(
    calculation: dict, collected: dict, intent: str
) -> str:
    """
    ê³„ì‚° ê²°ê³¼ë¥¼ ìì—°ì–´ë¡œ í•©ì„± (ê°œì„  ë²„ì „)

    Args:
        calculation: ê³„ì‚° ê²°ê³¼ (breakdown í¬í•¨)
        collected: ìˆ˜ì§‘ëœ íŒŒë¼ë¯¸í„°
        intent: ì‚¬ìš©ì ì˜ë„

    Returns:
        ìì—°ì–´ ì‘ë‹µ
    """
    try:
        from ai.prompts.clarifying import SYNTHESIS_PROMPT_V2

        # Breakdown ì •ë³´ ì¶”ì¶œ
        breakdown = calculation.get("calculation_breakdown", {})

        # ì„¸ìœ¨ êµ¬ê°„í‘œ í¬ë§·íŒ…
        all_brackets = breakdown.get("all_tax_brackets", [])
        tax_brackets_text = "\n".join([
            f"   â€¢ {b['range']}: {b['rate_display']} "
            f"(ëˆ„ì§„ê³µì œ {b['progressive_deduction_formatted']})"
            + (" â† ì—¬ê¸°!" if b.get("is_current") else "")
            for b in all_brackets
        ])

        # ê³„ì‚° ë‹¨ê³„ í¬ë§·íŒ…
        calc_steps = breakdown.get("calculation_steps_detailed", [])
        steps_text = "\n".join([
            f"   {s['description']}: {s['formatted']}"
            + (f" ({s['calculation']})" if s.get('calculation') else "")
            for s in calc_steps
        ])

        # Warnings í¬ë§·íŒ…
        warnings = calculation.get("warnings", [])
        warnings_text = "\n".join([f"âš ï¸ {w}" for w in warnings]) if warnings else ""

        # í¬ë§·íŒ…ëœ ê¸ˆì•¡ ì •ë³´
        formatted_amounts = breakdown.get("formatted_amounts", {})
        tax_bracket = breakdown.get("tax_bracket", {})

        # í”„ë¡¬í”„íŠ¸ ë³€ìˆ˜ ì¤€ë¹„
        prompt_vars = {
            "final_tax_formatted": formatted_amounts.get("final_tax", ""),
            "gift_value_formatted": formatted_amounts.get("gift_value", ""),
            "deduction_formatted": formatted_amounts.get("total_deduction", ""),
            "taxable_base_formatted": formatted_amounts.get("taxable_base", ""),
            "tax_bracket_range": tax_bracket.get("range", ""),
            "tax_rate": tax_bracket.get("rate_display", ""),
            "progressive_deduction_formatted": tax_bracket.get("progressive_deduction_formatted", ""),
            "calculation_steps_formatted": steps_text,
            "all_tax_brackets_formatted": tax_brackets_text,
            "warnings_formatted": warnings_text
        }

        # í”„ë¡¬í”„íŠ¸ ìƒì„±
        prompt = SYNTHESIS_PROMPT_V2.format(**prompt_vars)

        # Gemini API í˜¸ì¶œ
        settings = GeminiSettings.from_env()
        client = GeminiClient(settings)

        response = await client.generate_content(
            system_prompt="",
            user_message=prompt
        )

        LOGGER.info("Synthesis successful with V2 prompt")
        return response

    except GeminiClientError:
        LOGGER.exception("Synthesis error")
        # Fallback: ê°„ë‹¨í•œ í…œí”Œë¦¿ ê¸°ë°˜ ì‘ë‹µ
        from ai.tools.gift_tax.calculator import format_amount

        final_tax = calculation.get("final_tax", 0)
        gift_value = calculation.get("gift_value", 0)

        fallback_response = f"""ì¦ì—¬ì„¸ ê³„ì‚° ê²°ê³¼ì˜ˆìš”.

ì¦ì—¬ì¬ì‚° {format_amount(gift_value)}ì— ëŒ€í•œ ì¦ì—¬ì„¸ëŠ” ì•½ {format_amount(final_tax)}ì´ì—ìš”.

ì •í™•í•œ ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ì„¸ë¬´ì‚¬ì™€ ìƒë‹´í•˜ì‹œëŠ” ê±¸ ê¶Œì¥ë“œë ¤ìš”.
"""
        return fallback_response
```

---

# 2. Calculation API ìŠ¤í™

## 2.1 í˜„ì¬ Steps êµ¬ì¡° ë¶„ì„

### ê¸°ì¡´ ì¶œë ¥ ì˜ˆì‹œ
```json
{
  "calculation": {
    "steps": [
      {
        "step": 1,
        "value": 1000000000,
        "detail": "1,000,000,000ì› - 0ì›",
        "formula": "ì¦ì—¬ë°›ì€ ì¬ì‚°ê°€ì•¡ - ì±„ë¬´ì•¡",
        "description": "ì¦ì—¬ì¬ì‚°ê°€ì•¡"
      },
      {
        "step": 2,
        "value": 50000000,
        "detail": "ê¸°ë³¸ 50,000,000ì› + í˜¼ì¸ 0ì› + ì¶œì‚° 0ì›",
        "formula": "ê¸°ë³¸ê³µì œ + í˜¼ì¸ê³µì œ + ì¶œì‚°ê³µì œ",
        "description": "ì¦ì—¬ì¬ì‚°ê³µì œ"
      },
      {
        "step": 3,
        "value": 950000000,
        "detail": "1,000,000,000ì› - 50,000,000ì›",
        "formula": "ì¦ì—¬ì¬ì‚°ê°€ì•¡ - ì¦ì—¬ì¬ì‚°ê³µì œ",
        "description": "ê³¼ì„¸í‘œì¤€"
      },
      {
        "step": 4,
        "value": 225000000,
        "detail": "950,000,000ì› Ã— 30% - 60,000,000ì›",
        "formula": "ê³¼ì„¸í‘œì¤€ Ã— ì„¸ìœ¨ - ëˆ„ì§„ê³µì œ",
        "description": "ì‚°ì¶œì„¸ì•¡"
      },
      {
        "step": 6,
        "value": 225000000,
        "detail": "225,000,000ì› + 0ì›",
        "formula": "ì‚°ì¶œì„¸ì•¡ + í• ì¦ì„¸ì•¡",
        "description": "ìµœì¢… ì¦ì—¬ì„¸ì•¡"
      }
    ]
  }
}
```

### ë¬¸ì œì 
1. **Step 5 ëˆ„ë½**: Step 4ì—ì„œ 6ìœ¼ë¡œ ë°”ë¡œ ì í”„
2. **ëˆ„ì§„ê³µì œ ì„¤ëª… ë¶€ì¡±**: Step 4ì— í†µí•©ë˜ì–´ ìˆìŒ
3. **í• ì¦ì„¸ì•¡ í‘œì‹œ**: ê±°ì˜ í•­ìƒ 0ì›ì¸ë° ë³„ë„ step
4. **Unicode escape**: `\uc99d\uc5ec` ê°™ì€ í˜•íƒœ (JSON ì¸ì½”ë”© ë¬¸ì œ)

## 2.2 ê°œì„ ëœ API ì¶œë ¥ êµ¬ì¡°

### ì™„ì „í•œ ì‘ë‹µ ì˜ˆì‹œ

```json
{
  "final_tax": 225000000,
  "gift_value": 1000000000,
  "total_deduction": 50000000,
  "taxable_base": 950000000,

  "steps": [
    {
      "step": 1,
      "value": 1000000000,
      "detail": "1,000,000,000ì› - 0ì›",
      "formula": "ì¦ì—¬ë°›ì€ ì¬ì‚°ê°€ì•¡ - ì±„ë¬´ì•¡",
      "description": "ì¦ì—¬ì¬ì‚°ê°€ì•¡"
    },
    {
      "step": 2,
      "value": 50000000,
      "detail": "ê¸°ë³¸ 50,000,000ì› + í˜¼ì¸ 0ì› + ì¶œì‚° 0ì›",
      "formula": "ê¸°ë³¸ê³µì œ + í˜¼ì¸ê³µì œ + ì¶œì‚°ê³µì œ",
      "description": "ì¦ì—¬ì¬ì‚°ê³µì œ"
    },
    {
      "step": 3,
      "value": 950000000,
      "detail": "1,000,000,000ì› - 50,000,000ì›",
      "formula": "ì¦ì—¬ì¬ì‚°ê°€ì•¡ - ì¦ì—¬ì¬ì‚°ê³µì œ",
      "description": "ê³¼ì„¸í‘œì¤€"
    },
    {
      "step": 4,
      "value": 285000000,
      "detail": "950,000,000ì› Ã— 30%",
      "formula": "ê³¼ì„¸í‘œì¤€ Ã— ì„¸ìœ¨",
      "description": "ì‚°ì¶œì„¸ì•¡ (ëˆ„ì§„ê³µì œ ì°¨ê° ì „)"
    },
    {
      "step": 5,
      "value": 60000000,
      "detail": "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜ êµ¬ê°„",
      "formula": "ì„¸ìœ¨ êµ¬ê°„ë³„ ëˆ„ì§„ê³µì œ",
      "description": "ëˆ„ì§„ê³µì œ"
    },
    {
      "step": 6,
      "value": 225000000,
      "detail": "285,000,000ì› - 60,000,000ì›",
      "formula": "ì‚°ì¶œì„¸ì•¡ - ëˆ„ì§„ê³µì œ",
      "description": "ìµœì¢… ì¦ì—¬ì„¸ì•¡"
    }
  ],

  "calculation_breakdown": {
    "formatted_amounts": {
      "gift_value": "10ì–µì›",
      "total_deduction": "5,000ë§Œì›",
      "taxable_base": "9ì–µ 5,000ë§Œì›",
      "calculated_tax": "2ì–µ 8,500ë§Œì›",
      "progressive_deduction": "6,000ë§Œì›",
      "final_tax": "2ì–µ 2,500ë§Œì›"
    },

    "tax_bracket": {
      "range": "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜",
      "min": 500000001,
      "max": 1000000000,
      "rate": 0.30,
      "rate_display": "30%",
      "progressive_deduction": 60000000,
      "progressive_deduction_formatted": "6,000ë§Œì›",
      "is_current": true
    },

    "all_tax_brackets": [
      {
        "range": "1ì–µ ì´í•˜",
        "min": 0,
        "max": 100000000,
        "rate": 0.10,
        "rate_display": "10%",
        "progressive_deduction": 0,
        "progressive_deduction_formatted": "0ì›",
        "is_current": false
      },
      {
        "range": "1ì–µ ì´ˆê³¼ ~ 5ì–µ ì´í•˜",
        "min": 100000001,
        "max": 500000000,
        "rate": 0.20,
        "rate_display": "20%",
        "progressive_deduction": 10000000,
        "progressive_deduction_formatted": "1,000ë§Œì›",
        "is_current": false
      },
      {
        "range": "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜",
        "min": 500000001,
        "max": 1000000000,
        "rate": 0.30,
        "rate_display": "30%",
        "progressive_deduction": 60000000,
        "progressive_deduction_formatted": "6,000ë§Œì›",
        "is_current": true
      },
      {
        "range": "10ì–µ ì´ˆê³¼ ~ 30ì–µ ì´í•˜",
        "min": 1000000001,
        "max": 3000000000,
        "rate": 0.40,
        "rate_display": "40%",
        "progressive_deduction": 160000000,
        "progressive_deduction_formatted": "1.6ì–µì›",
        "is_current": false
      },
      {
        "range": "30ì–µ ì´ˆê³¼",
        "min": 3000000001,
        "max": null,
        "rate": 0.50,
        "rate_display": "50%",
        "progressive_deduction": 460000000,
        "progressive_deduction_formatted": "4.6ì–µì›",
        "is_current": false
      }
    ],

    "calculation_steps_detailed": [
      {
        "step": 1,
        "description": "ì¦ì—¬ì¬ì‚°ê°€ì•¡",
        "value": 1000000000,
        "formatted": "10ì–µì›"
      },
      {
        "step": 2,
        "description": "ì¦ì—¬ì¬ì‚°ê³µì œ (ì§ê³„ì¡´ì† â†’ ì„±ì¸ìë…€)",
        "value": 50000000,
        "formatted": "5,000ë§Œì›",
        "breakdown": {
          "basic": "5,000ë§Œì›",
          "marriage": null,
          "childbirth": null
        }
      },
      {
        "step": 3,
        "description": "ê³¼ì„¸í‘œì¤€",
        "value": 950000000,
        "formatted": "9ì–µ 5,000ë§Œì›",
        "calculation": "10ì–µì› - 5,000ë§Œì›"
      },
      {
        "step": 4,
        "description": "ì‚°ì¶œì„¸ì•¡ (ëˆ„ì§„ê³µì œ ì „)",
        "value": 285000000,
        "formatted": "2ì–µ 8,500ë§Œì›",
        "calculation": "9.5ì–µì› Ã— 30%"
      },
      {
        "step": 5,
        "description": "ëˆ„ì§„ê³µì œ",
        "value": 60000000,
        "formatted": "6,000ë§Œì›",
        "info": "5ì–µ ì´ˆê³¼ ~ 10ì–µ ì´í•˜ êµ¬ê°„"
      },
      {
        "step": 6,
        "description": "ìµœì¢… ì¦ì—¬ì„¸ì•¡",
        "value": 225000000,
        "formatted": "2ì–µ 2,500ë§Œì›",
        "calculation": "2ì–µ 8,500ë§Œì› - 6,000ë§Œì›"
      }
    ]
  },

  "warnings": [
    "ì¦ì—¬ì¼ë¡œë¶€í„° 3ê°œì›” ì´ë‚´(2025ë…„ 10ì›” 31ì¼ê¹Œì§€, ë‚¨ì€ ê¸°ê°„: 13ì¼) ì‹ ê³ í•´ì•¼ í•©ë‹ˆë‹¤."
  ]
}
```

---

# 3. Frontend API Contract

## 3.1 ê°œìš”

ì´ ë¬¸ì„œëŠ” Frontendì™€ Backend ê°„ ì¦ì—¬ì„¸ ê³„ì‚° API í†µì‹  ê·œê²©ì„ ì •ì˜í•©ë‹ˆë‹¤.

**ê´€ë ¨ ë¬¸ì„œ:**
- [Backend API Contract](ai/backend_api_contract.md) - ê¸°ì¡´ ë¬¸ì„œ (AI â†” Backend)
- ë³¸ ë¬¸ì„œ - Frontend â†” Backend

## 3.2 Base URL

```
Development: http://localhost:8000
Production: TBD
```

## 3.3 API Endpoints

### 3.3.1 ì„¸ì…˜ ìƒì„±

**Endpoint:** `POST /sessions`

**Request:**
```json
{
  "client_id_hash": "optional-hash-string"
}
```

**Response:** `201 Created`
```json
{
  "id": "61e3f2ba-4130-40bc-bf21-a2f904fcd493",
  "client_id_hash": "hash-string",
  "created_at": "2025-10-17T09:30:00Z"
}
```

### 3.3.2 ë©”ì‹œì§€ ì „ì†¡ (ì¦ì—¬ì„¸ ê³„ì‚° ìš”ì²­)

**Endpoint:** `POST /sessions/{session_id}/messages`

**Request:**
```json
{
  "content": "ì˜¬í•´ 8ì›”ì— ì•„ë¹ í•œí…Œ 10ì–µ ì •ë„ ë°›ì„ê±° ê°™ì€ë°"
}
```

**Response:** `200 OK`

ì‘ë‹µ ì˜ˆì‹œëŠ” ì„¹ì…˜ 2.2ì˜ "ì™„ì „í•œ ì‘ë‹µ ì˜ˆì‹œ" ì°¸ì¡°.

`msg_metadata` í•„ë“œì— ë‹¤ìŒ ì •ë³´ í¬í•¨:
- `intent`: ì‚¬ìš©ì ì˜ë„ ("gift_tax", "inheritance_tax", "general_info", "out_of_scope")
- `collected_parameters`: ìˆ˜ì§‘ëœ íŒŒë¼ë¯¸í„° (9ê°œ ë³€ìˆ˜)
- `calculation`: ê³„ì‚° ê²°ê³¼ (steps + calculation_breakdown í¬í•¨)

### 3.3.3 ëŒ€í™” ë‚´ì—­ ì¡°íšŒ

**Endpoint:** `GET /sessions/{session_id}/messages?limit=30`

**Response:** `200 OK`
```json
{
  "messages": [
    {
      "id": "msg-1",
      "session_id": "session-uuid",
      "role": "user",
      "content": "ì¦ì—¬ì„¸ ê³„ì‚°í•´ì¤˜",
      "created_at": "2025-10-17T09:30:00Z",
      "msg_metadata": null
    },
    {
      "id": "msg-2",
      "session_id": "session-uuid",
      "role": "assistant",
      "content": "ì¦ì—¬ì¼ì´ ì–¸ì œì¸ê°€ìš”?",
      "created_at": "2025-10-17T09:30:01Z",
      "msg_metadata": {
        "intent": "gift_tax",
        "collected_parameters": {},
        "missing_parameters": ["gift_date", "donor_relationship", "gift_property_value"]
      }
    }
  ],
  "next_cursor": null
}
```

## 3.4 TypeScript íƒ€ì… ì •ì˜

```typescript
// Session
interface Session {
  id: string;
  client_id_hash?: string;
  created_at: string;
}

// Message
interface Message {
  id: string;
  session_id: string;
  role: 'user' | 'assistant';
  content: string;
  created_at: string;
  msg_metadata?: MessageMetadata;
}

// Message Metadata
interface MessageMetadata {
  intent?: 'gift_tax' | 'inheritance_tax' | 'general_info' | 'out_of_scope';
  collected_parameters?: CollectedParameters;
  missing_parameters?: string[];
  calculation?: CalculationResult;
}

// Collected Parameters
interface CollectedParameters {
  gift_date?: string;  // YYYY-MM-DD
  donor_relationship?: 'ì§ê³„ì¡´ì†' | 'ì§ê³„ë¹„ì†' | 'ë°°ìš°ì' | 'ê¸°íƒ€ì¹œì¡±';
  gift_property_value?: number;
  is_generation_skipping?: boolean;
  is_minor_recipient?: boolean;
  is_non_resident?: boolean;
  marriage_deduction_amount?: number;
  childbirth_deduction_amount?: number;
  secured_debt?: number;
}

// Calculation Result
interface CalculationResult {
  final_tax: number;
  gift_value: number;
  total_deduction: number;
  taxable_base: number;
  steps: CalculationStep[];
  calculation_breakdown: CalculationBreakdown;
  warnings: string[];
}

// Calculation Step (ê¸°ì¡´ ìŠ¤í™)
interface CalculationStep {
  step: number;
  value: number;
  detail: string;
  formula: string;
  description: string;
}

// Calculation Breakdown (ì‹ ê·œ)
interface CalculationBreakdown {
  formatted_amounts: {
    gift_value: string;
    total_deduction: string;
    taxable_base: string;
    calculated_tax: string;
    progressive_deduction: string;
    final_tax: string;
  };

  tax_bracket: TaxBracket;
  all_tax_brackets: TaxBracket[];
  calculation_steps_detailed: DetailedCalculationStep[];
}

// Tax Bracket
interface TaxBracket {
  range: string;
  min: number;
  max: number | null;
  rate: number;
  rate_display: string;
  progressive_deduction: number;
  progressive_deduction_formatted: string;
  is_current: boolean;
}

// Detailed Calculation Step
interface DetailedCalculationStep {
  step: number;
  description: string;
  value: number;
  formatted: string;
  calculation?: string;
  breakdown?: {
    basic?: string;
    marriage?: string | null;
    childbirth?: string | null;
  };
  info?: string;
}
```

## 3.5 Frontend í™œìš© ì˜ˆì‹œ

### ì‹œê°í™” ì˜ˆì‹œ 1: ê³„ì‚° ê³¼ì • í‘œì‹œ

```tsx
interface CalculationStep {
  step: number;
  description: string;
  value: number;
  formatted: string;
  calculation?: string;
  breakdown?: {
    basic?: string;
    marriage?: string | null;
    childbirth?: string | null;
  };
}

function CalculationProcess({ steps }: { steps: CalculationStep[] }) {
  return (
    <div className="calculation-process">
      <h3>ğŸ“Š ìƒì„¸ ê³„ì‚° ê³¼ì •</h3>
      {steps.map((step) => (
        <div key={step.step} className="step-item">
          <div className="step-number">#{step.step}</div>
          <div className="step-content">
            <div className="step-description">{step.description}</div>
            <div className="step-value">{step.formatted}</div>
            {step.calculation && (
              <div className="step-calculation">
                = {step.calculation}
              </div>
            )}
            {step.breakdown && (
              <div className="step-breakdown">
                {step.breakdown.basic && <span>ê¸°ë³¸: {step.breakdown.basic}</span>}
                {step.breakdown.marriage && <span>í˜¼ì¸: {step.breakdown.marriage}</span>}
                {step.breakdown.childbirth && <span>ì¶œì‚°: {step.breakdown.childbirth}</span>}
              </div>
            )}
          </div>
        </div>
      ))}
    </div>
  );
}
```

### ì‹œê°í™” ì˜ˆì‹œ 2: ì„¸ìœ¨í‘œ í‘œì‹œ

```tsx
interface TaxBracket {
  range: string;
  rate_display: string;
  progressive_deduction_formatted: string;
  is_current: boolean;
}

function TaxBracketTable({ brackets }: { brackets: TaxBracket[] }) {
  return (
    <div className="tax-bracket-table">
      <h4>ì¦ì—¬ì„¸ ì„¸ìœ¨í‘œ</h4>
      <table>
        <thead>
          <tr>
            <th>ê³¼ì„¸í‘œì¤€ êµ¬ê°„</th>
            <th>ì„¸ìœ¨</th>
            <th>ëˆ„ì§„ê³µì œ</th>
          </tr>
        </thead>
        <tbody>
          {brackets.map((bracket, idx) => (
            <tr
              key={idx}
              className={bracket.is_current ? 'current-bracket' : ''}
            >
              <td>
                {bracket.range}
                {bracket.is_current && <span className="badge">í˜„ì¬</span>}
              </td>
              <td>{bracket.rate_display}</td>
              <td>{bracket.progressive_deduction_formatted}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

### ì‹œê°í™” ì˜ˆì‹œ 3: ê²°ê³¼ ìš”ì•½ ì¹´ë“œ

```tsx
interface CalculationSummary {
  gift_value: string;
  total_deduction: string;
  taxable_base: string;
  final_tax: string;
}

function SummaryCard({ summary }: { summary: CalculationSummary }) {
  return (
    <div className="summary-card">
      <h2>ğŸ“‹ ê³„ì‚° ê²°ê³¼</h2>
      <div className="summary-row">
        <span className="label">ì¦ì—¬ì¬ì‚°ê°€ì•¡</span>
        <span className="value">{summary.gift_value}</span>
      </div>
      <div className="summary-row">
        <span className="label">ê³µì œì•¡</span>
        <span className="value deduction">-{summary.total_deduction}</span>
      </div>
      <div className="summary-row total">
        <span className="label">ê³¼ì„¸í‘œì¤€</span>
        <span className="value">{summary.taxable_base}</span>
      </div>
      <div className="summary-row highlight">
        <span className="label">ìµœì¢… ì¦ì—¬ì„¸</span>
        <span className="value tax">{summary.final_tax}</span>
      </div>
    </div>
  );
}
```

## 3.6 Error Responses

### 4xx Client Errors

**400 Bad Request**
```json
{
  "error": "Bad Request",
  "message": "Invalid session_id format"
}
```

**404 Not Found**
```json
{
  "error": "Not Found",
  "message": "Session not found"
}
```

### 5xx Server Errors

**500 Internal Server Error**
```json
{
  "error": "Internal Server Error",
  "message": "An unexpected error occurred"
}
```

## 3.7 API Client êµ¬í˜„ ì˜ˆì‹œ

```typescript
class GiftTaxApiClient {
  private baseUrl: string;

  constructor(baseUrl: string = 'http://localhost:8000') {
    this.baseUrl = baseUrl;
  }

  async createSession(clientIdHash?: string): Promise<Session> {
    const response = await fetch(`${this.baseUrl}/sessions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ client_id_hash: clientIdHash }),
    });
    return response.json();
  }

  async sendMessage(sessionId: string, content: string): Promise<Message> {
    const response = await fetch(
      `${this.baseUrl}/sessions/${sessionId}/messages`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      }
    );
    return response.json();
  }

  async getMessages(
    sessionId: string,
    limit: number = 30,
    cursor?: string
  ): Promise<{ messages: Message[]; next_cursor: string | null }> {
    const params = new URLSearchParams({ limit: limit.toString() });
    if (cursor) params.append('cursor', cursor);

    const response = await fetch(
      `${this.baseUrl}/sessions/${sessionId}/messages?${params}`
    );
    return response.json();
  }
}
```

---

## ë¶€ë¡: êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Backend êµ¬í˜„ (ai/tools/gift_tax/calculator.py)
- [ ] `format_amount()` í•¨ìˆ˜ êµ¬í˜„
- [ ] `get_tax_bracket_info()` í•¨ìˆ˜ êµ¬í˜„
- [ ] `get_all_tax_brackets()` í•¨ìˆ˜ êµ¬í˜„
- [ ] `calculate_gift_tax_simple()` ì— `calculation_breakdown` ì¶”ê°€
- [ ] Steps 1-6 ëª¨ë‘ í¬í•¨ (ëˆ„ë½ ì—†ì´)
- [ ] ìœ ë‹ˆì½”ë“œ escape ë¬¸ì œ í•´ê²°

### Prompt ê°œì„  (ai/prompts/clarifying.py)
- [ ] `SYNTHESIS_PROMPT_V2` ì‘ì„±
- [ ] í˜ë¥´ì†Œë‚˜ ê°€ì´ë“œë¼ì¸ ì¶”ê°€
- [ ] Few-shot ì˜ˆì œ 3ê°œ ì¶”ê°€
- [ ] êµ¬ì¡°í™”ëœ ì‘ë‹µ í…œí”Œë¦¿ ëª…ì‹œ

### Synthesis Node (ai/pipelines/langgraph_workflow.py)
- [ ] `_synthesize_response()` ê°œì„ 
- [ ] Breakdown ì •ë³´ í™œìš©
- [ ] Fallback ì‘ë‹µ ê°œì„ 

### í…ŒìŠ¤íŠ¸
- [ ] 10ì–µ ì¦ì—¬ ì‹œë‚˜ë¦¬ì˜¤
- [ ] 5ì–µ ë°°ìš°ì ì¦ì—¬ ì‹œë‚˜ë¦¬ì˜¤
- [ ] 50ì–µ ê³ ì•¡ ì¦ì—¬ ì‹œë‚˜ë¦¬ì˜¤
- [ ] ì‘ë‹µ í’ˆì§ˆ ê²€ì¦
- [ ] API ì‘ë‹µ í˜•ì‹ ê²€ì¦

---

**ë¬¸ì„œ ë²„ì „:** 1.0
**ìµœì¢… ìˆ˜ì •ì¼:** 2025-10-17
